{"version":3,"file":"index.es.js","sources":["../src/support.ts","../src/Image.tsx"],"sourcesContent":["import { useEffect, useLayoutEffect } from 'react'\n\nexport const isBrowser = typeof window !== 'undefined'\n\nexport const isomorphicLayoutEffect = isBrowser ? useLayoutEffect : useEffect\n\nconst imageCache = Object.create({})\n\nexport function getImageCache(id: string): null | number {\n  return (!!imageCache[id] && imageCache[id][window.location.href]) || null\n}\n\nexport function setImageCache(id: string, sizes: number): void {\n  imageCache[id] = {\n    ...(imageCache[id] || {}),\n    ...{ [window.location.href]: sizes },\n  }\n}\n\nexport function getSizes(el: any, src): number {\n  if (getImageCache(src)) {\n    return getImageCache(src) || 100\n  }\n\n  const min = 32\n  let currentNode = el\n  if (currentNode.getBoundingClientRect().width < min) {\n    currentNode = currentNode.parentNode\n\n    while (currentNode.tagName !== 'BODY' && currentNode.getBoundingClientRect().width <= min) {\n      currentNode = currentNode.parentNode\n    }\n  }\n\n  return Math.ceil((currentNode.getBoundingClientRect().width / window.innerWidth) * 100)\n}\n\nexport const hasNativeLazyLoadSupport =\n  typeof HTMLImageElement !== 'undefined' && 'loading' in HTMLImageElement.prototype\nexport const hasIOSupport = isBrowser && window.IntersectionObserver\n\nexport function getIO(node, cb): IntersectionObserver {\n  const observer = new window.IntersectionObserver(\n    ([entry]) => {\n      if (entry.isIntersecting || entry.intersectionRatio > 0) {\n        observer.unobserve(node)\n        cb()\n      }\n    },\n    { rootMargin: '200px' },\n  )\n  observer.observe(node)\n  return observer\n}\n\nexport const generateSources = (object: { [x: number]: string }): string =>\n  Object.entries(object)\n    .map(([size, url]) => `${url} ${size}w`)\n    .join(', ')\n","/* eslint max-lines: \"off\" */\nimport React, { CSSProperties, ReactElement, useRef, useState } from 'react'\n\nimport {\n  getSizes,\n  getIO,\n  generateSources,\n  hasNativeLazyLoadSupport,\n  hasIOSupport,\n  setImageCache,\n  getImageCache,\n  isomorphicLayoutEffect,\n} from './support'\n\ntype Props = {\n  src: string\n  srcSet?: { [x: number]: string }\n  webpSrcSet?: { [x: number]: string }\n  sizes?: number | 'auto'\n  placeholder?: string\n  loading?: 'lazy' | 'auto' | 'eager'\n  aspectRatio?: number\n  height?: string | number\n  critical?: boolean\n  fadeIn?: boolean\n  durationFadeIn?: number\n  className?: string\n  imgStyle?: object\n  imgClass?: string\n  placeholderStyle?: object\n  placeholderClass?: string\n  sizerStyle?: object\n  sizerClass?: string\n  bgColor?: string\n  alt?: string\n  fit?: 'cover' | 'contain'\n  position?: string\n  transparent?: boolean\n}\n\n// eslint-disable-next-line complexity\nexport function Image(props: Props): ReactElement {\n  /*****************************************************************************\n   * Refs\n   *****************************************************************************/\n  const imgRef = useRef(null)\n  const node: any = useRef(null)\n\n  /*****************************************************************************\n   * Variables\n   *****************************************************************************/\n  const imgHeight = props.aspectRatio ? `${100 / props.aspectRatio}%` : props.height\n  const isCritical = props.loading === 'eager' || props.critical\n  const seenBefore = !!getImageCache(props.src)\n\n  /*****************************************************************************\n   * State\n   *****************************************************************************/\n  const [state, changeState] = useState({\n    sizes: seenBefore ? getImageCache(props.src) : (props.sizes || 100),\n    isVisible: seenBefore || isCritical || hasNativeLazyLoadSupport || !hasIOSupport,\n    shouldFadeIn: !seenBefore || props.fadeIn,\n    imgLoaded: seenBefore || false,\n  })\n\n  /*****************************************************************************\n   * Functions\n   *****************************************************************************/\n  const setState = (value: any): void => changeState(state => ({ ...state, ...value }))\n\n  function handleImageLoaded(): void {\n    if (!seenBefore) {\n      setImageCache(props.src, Number(state.sizes))\n      setState({ imgLoaded: true })\n    }\n  }\n\n  /*****************************************************************************\n   * Effects\n   *****************************************************************************/\n  isomorphicLayoutEffect(() => {\n    if (!seenBefore) {\n      setState({ sizes: props.sizes || getSizes(node.current, props.src) })\n    }\n    const observer = !state.isVisible && getIO(node.current, () => setState({ isVisible: true }))\n\n    if (isCritical) {\n      const img: any = imgRef.current\n      if (img && img.complete) {\n        handleImageLoaded()\n      }\n    }\n\n    return () => {\n      if (observer) {\n        observer.unobserve(node.current)\n      }\n    }\n  }, [])\n\n  /*****************************************************************************\n   * Styles\n   *****************************************************************************/\n  const shouldReveal = !state.shouldFadeIn || state.imgLoaded\n\n  const defaultImageStyles: CSSProperties = {\n    position: 'absolute',\n    top: 0,\n    left: 0,\n    width: '100%',\n    height: '100%',\n    objectFit: props.fit,\n    objectPosition: props.position,\n  }\n\n  const imageStyle: CSSProperties = {\n    opacity: shouldReveal ? 1 : 0,\n    transition: state.shouldFadeIn ? `opacity ${props.durationFadeIn}ms` : 'none',\n    ...props.imgStyle,\n  }\n  const delayHideStyle: CSSProperties = {\n    transition: props.transparent && state.shouldFadeIn ? `opacity ${props.durationFadeIn}ms` : undefined,\n    transitionDelay: props.transparent ? '0' : `${props.durationFadeIn}ms`,\n  }\n  const imagePlaceholderStyle: CSSProperties = {\n    opacity: state.imgLoaded ? 0 : 1,\n    ...(state.shouldFadeIn && delayHideStyle),\n    ...props.imgStyle,\n    ...props.placeholderStyle,\n  }\n\n  /*****************************************************************************\n   * Render\n   *****************************************************************************/\n  return (\n    <div style={{ position: 'relative', overflow: 'hidden' }} className={props.className}>\n      <div\n        style={{ width: '100%', paddingBottom: imgHeight, ...props.sizerStyle }}\n        ref={node}\n        className={props.sizerClass}\n      />\n\n      {props.bgColor && (\n        <div\n          className={props.placeholderClass}\n          style={{\n            backgroundColor: props.bgColor,\n            ...defaultImageStyles,\n            ...imagePlaceholderStyle,\n          }}\n        />\n      )}\n\n      {!props.bgColor && props.placeholder && (\n        <img\n          src={props.placeholder}\n          alt={props.alt}\n          className={props.placeholderClass}\n          style={{\n            ...defaultImageStyles,\n            ...imagePlaceholderStyle,\n          }}\n        />\n      )}\n\n      {state.isVisible && (\n        <picture>\n          {props.webpSrcSet && (\n            <source\n              type=\"image/webp\"\n              srcSet={generateSources(props.webpSrcSet)}\n              sizes={state.sizes ? `${state.sizes}vw` : undefined}\n            />\n          )}\n          {props.srcSet && (\n            <source\n              srcSet={generateSources(props.srcSet)}\n              sizes={state.sizes ? `${state.sizes}vw` : undefined}\n            />\n          )}\n\n          <img\n            ref={imgRef}\n            src={props.src}\n            className={props.imgClass}\n            alt={props.alt}\n            sizes={`${state.sizes}vw`}\n            // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n            // @ts-ignore\n            loading={isCritical ? 'eager' : props.loading}\n            onLoad={handleImageLoaded}\n            style={{\n              ...defaultImageStyles,\n              ...imageStyle,\n            }}\n          />\n        </picture>\n      )}\n    </div>\n  )\n}\n\nImage.defaultProps = {\n  loading: 'lazy',\n  fadeIn: true,\n  fit: 'cover',\n  position: 'center',\n  height: '100%',\n  durationFadeIn: 500,\n  alt: '',\n}\n"],"names":[],"mappings":"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"}