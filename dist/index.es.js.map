{"version":3,"file":"index.es.js","sources":["../src/support.ts","../src/Image.tsx"],"sourcesContent":["import { useEffect, useLayoutEffect } from 'react'\n\nexport const isBrowser = typeof window !== 'undefined'\n\nexport const isomorphicLayoutEffect = isBrowser ? useLayoutEffect : useEffect\n\nconst imageCache = Object.create({})\n\nexport function getImageCache(id: string): null | number {\n  return (!!imageCache[id] && imageCache[id][window.location.href]) || null\n}\n\nexport function setImageCache(id: string, sizes: number): void {\n  imageCache[id] = {\n    ...(imageCache[id] || {}),\n    ...{ [window.location.href]: sizes },\n  }\n}\n\nexport function getSizes(el: any, src): number {\n  if (getImageCache(src)) {\n    return getImageCache(src) || 100\n  }\n\n  const min = 32\n  let currentNode = el\n  if (currentNode.getBoundingClientRect().width < min) {\n    currentNode = currentNode.parentNode\n\n    while (currentNode.tagName !== 'BODY' && currentNode.getBoundingClientRect().width <= min) {\n      currentNode = currentNode.parentNode\n    }\n  }\n\n  return Math.ceil((currentNode.getBoundingClientRect().width / window.innerWidth) * 100)\n}\n\nexport const hasNativeLazyLoadSupport =\n  typeof HTMLImageElement !== 'undefined' && 'loading' in HTMLImageElement.prototype\n\nexport const hasIOSupport = isBrowser && window.IntersectionObserver\n\nexport function getIO(node, cb): IntersectionObserver {\n  const observer = new window.IntersectionObserver(\n    ([entry]) => {\n      if (entry.isIntersecting || entry.intersectionRatio > 0) {\n        observer.unobserve(node)\n        cb()\n      }\n    },\n    { rootMargin: '200px' },\n  )\n  observer.observe(node)\n  return observer\n}\n\nexport const generateSources = (object: { [x: number]: string }): string =>\n  Object.entries(object)\n    .map(([size, url]) => `${url} ${size}w`)\n    .join(', ')\n","/* eslint max-lines: \"off\" */\nimport React, { CSSProperties, ReactElement, useRef, useState } from 'react'\n\nimport {\n  getSizes,\n  getIO,\n  generateSources,\n  hasNativeLazyLoadSupport,\n  hasIOSupport,\n  setImageCache,\n  getImageCache,\n  isomorphicLayoutEffect,\n} from './support'\n\ntype Props = {\n  src: string\n  srcSet?: { [x: number]: string }\n  webpSrcSet?: { [x: number]: string }\n  sizes?: number | 'auto'\n  placeholder?: string\n  loading?: 'lazy' | 'auto' | 'eager'\n  aspectRatio?: number\n  height?: string | number\n  critical?: boolean\n  fadeIn?: boolean\n  durationFadeIn?: number\n  className?: string\n  imgStyle?: object\n  imgClass?: string\n  placeholderStyle?: object\n  placeholderClass?: string\n  sizerStyle?: object\n  sizerClass?: string\n  bgColor?: string\n  alt?: string\n  fit?: 'cover' | 'contain'\n  position?: string\n  transparent?: boolean\n}\n\n// eslint-disable-next-line complexity\nexport function Image(props: Props): ReactElement {\n  /*****************************************************************************\n   * Refs\n   *****************************************************************************/\n  const imgRef = useRef(null)\n  const node: any = useRef(null)\n\n  /*****************************************************************************\n   * Variables\n   *****************************************************************************/\n  const imgHeight = props.aspectRatio ? `${100 / props.aspectRatio}%` : props.height\n  const isCritical = props.loading === 'eager' || props.critical\n  const seenBefore = !!getImageCache(props.src)\n\n  /*****************************************************************************\n   * State\n   *****************************************************************************/\n  const [state, changeState] = useState({\n    sizes: seenBefore ? getImageCache(props.src) : props.sizes || 100,\n    isVisible: seenBefore || isCritical || hasNativeLazyLoadSupport || !hasIOSupport,\n    shouldFadeIn: !seenBefore || props.fadeIn,\n    imgLoaded: seenBefore || false,\n  })\n\n  /*****************************************************************************\n   * Functions\n   *****************************************************************************/\n  const setState = (value: any): void => changeState(state => ({ ...state, ...value }))\n\n  function handleImageLoaded(): void {\n    if (!seenBefore) {\n      setImageCache(props.src, Number(state.sizes))\n      setState({ imgLoaded: true })\n    }\n  }\n\n  /*****************************************************************************\n   * Effects\n   *****************************************************************************/\n  isomorphicLayoutEffect(() => {\n    if (!seenBefore) {\n      setState({ sizes: props.sizes || getSizes(node.current, props.src) })\n    }\n    const observer = !state.isVisible && getIO(node.current, () => setState({ isVisible: true }))\n\n    if (isCritical) {\n      const img: any = imgRef.current\n      if (img && img.complete) {\n        handleImageLoaded()\n      }\n    }\n\n    return () => {\n      if (observer) {\n        observer.unobserve(node.current)\n      }\n    }\n  }, [])\n\n  /*****************************************************************************\n   * Styles\n   *****************************************************************************/\n  const shouldReveal = !state.shouldFadeIn || state.imgLoaded\n\n  const defaultImageStyles: CSSProperties = {\n    position: 'absolute',\n    top: 0,\n    left: 0,\n    width: '100%',\n    height: '100%',\n    objectFit: props.fit,\n    objectPosition: props.position,\n  }\n\n  const imageStyle: CSSProperties = {\n    opacity: shouldReveal ? 1 : 0,\n    transition: state.shouldFadeIn ? `opacity ${props.durationFadeIn}ms` : 'none',\n    ...props.imgStyle,\n  }\n  const delayHideStyle: CSSProperties = {\n    transition: props.transparent && state.shouldFadeIn ? `opacity ${props.durationFadeIn}ms` : undefined,\n    transitionDelay: props.transparent ? '0' : `${props.durationFadeIn}ms`,\n  }\n  const imagePlaceholderStyle: CSSProperties = {\n    opacity: state.imgLoaded ? 0 : 1,\n    ...(state.shouldFadeIn && delayHideStyle),\n    ...props.imgStyle,\n    ...props.placeholderStyle,\n  }\n\n  /*****************************************************************************\n   * Render\n   *****************************************************************************/\n  return (\n    <div style={{ position: 'relative', overflow: 'hidden' }} className={props.className}>\n      <div\n        style={{ width: '100%', paddingBottom: imgHeight, ...props.sizerStyle }}\n        ref={node}\n        className={props.sizerClass}\n      />\n\n      {props.bgColor && (\n        <div\n          className={props.placeholderClass}\n          style={{\n            backgroundColor: props.bgColor,\n            ...defaultImageStyles,\n            ...imagePlaceholderStyle,\n          }}\n        />\n      )}\n\n      {!props.bgColor && props.placeholder && (\n        <img\n          src={props.placeholder}\n          alt={props.alt}\n          className={props.placeholderClass}\n          style={{\n            ...defaultImageStyles,\n            ...imagePlaceholderStyle,\n          }}\n        />\n      )}\n\n      {state.isVisible && (\n        <picture>\n          {props.webpSrcSet && (\n            <source\n              type=\"image/webp\"\n              srcSet={generateSources(props.webpSrcSet)}\n              sizes={state.sizes ? `${state.sizes}vw` : undefined}\n            />\n          )}\n          {props.srcSet && (\n            <source\n              srcSet={generateSources(props.srcSet)}\n              sizes={state.sizes ? `${state.sizes}vw` : undefined}\n            />\n          )}\n\n          <img\n            ref={imgRef}\n            src={props.src}\n            className={props.imgClass}\n            alt={props.alt}\n            sizes={`${state.sizes}vw`}\n            // eslint-disable-next-line @typescript-eslint/ban-ts-ignore\n            // @ts-ignore\n            loading={isCritical ? 'eager' : props.loading}\n            onLoad={handleImageLoaded}\n            style={{\n              ...defaultImageStyles,\n              ...imageStyle,\n            }}\n          />\n        </picture>\n      )}\n    </div>\n  )\n}\n\nImage.defaultProps = {\n  loading: 'lazy',\n  fadeIn: true,\n  fit: 'cover',\n  position: 'center',\n  height: '100%',\n  durationFadeIn: 500,\n  alt: '',\n}\n"],"names":["isBrowser","window","isomorphicLayoutEffect","useLayoutEffect","useEffect","imageCache","Object","create","getImageCache","id","location","href","getSizes","el","src","currentNode","getBoundingClientRect","width","parentNode","tagName","Math","ceil","innerWidth","hasNativeLazyLoadSupport","HTMLImageElement","prototype","hasIOSupport","IntersectionObserver","generateSources","object","entries","map","size","url","join","Image","props","imgRef","useRef","node","imgHeight","aspectRatio","height","isCritical","loading","critical","seenBefore","state","changeState","useState","sizes","isVisible","shouldFadeIn","fadeIn","imgLoaded","setState","value","handleImageLoaded","Number","[object Object]","current","observer","cb","entry","isIntersecting","intersectionRatio","unobserve","rootMargin","observe","getIO","img","complete","shouldReveal","defaultImageStyles","position","top","left","objectFit","fit","objectPosition","imageStyle","opacity","transition","durationFadeIn","imgStyle","delayHideStyle","transparent","undefined","transitionDelay","imagePlaceholderStyle","placeholderStyle","React","style","overflow","className","paddingBottom","sizerStyle","ref","sizerClass","bgColor","placeholderClass","backgroundColor","placeholder","alt","webpSrcSet","type","srcSet","imgClass","onLoad","defaultProps"],"mappings":"oFAEO,MAAMA,EAA8B,oBAAXC,OAEnBC,EAAyBF,EAAYG,EAAkBC,EAE9DC,EAAaC,OAAOC,OAAO,aAEjBC,EAAcC,GAC5B,QAAUJ,EAAWI,IAAOJ,EAAWI,GAAIR,OAAOS,SAASC,OAAU,cAUvDC,EAASC,EAASC,GAChC,GAAIN,EAAcM,GAChB,OAAON,EAAcM,IAAQ,IAI/B,IAAIC,EAAcF,EAClB,GAAIE,EAAYC,wBAAwBC,MAF5B,GAKV,IAFAF,EAAcA,EAAYG,WAEK,SAAxBH,EAAYI,SAAsBJ,EAAYC,wBAAwBC,OALnE,IAMRF,EAAcA,EAAYG,WAI9B,OAAOE,KAAKC,KAAMN,EAAYC,wBAAwBC,MAAQhB,OAAOqB,WAAc,KAG9E,MAAMC,EACiB,oBAArBC,kBAAoC,YAAaA,iBAAiBC,UAE9DC,EAAe1B,GAAaC,OAAO0B,qBAgBzC,MAAMC,EAAmBC,GAC9BvB,OAAOwB,QAAQD,GACZE,IAAI,EAAEC,EAAMC,KAAS,GAAGA,KAAOD,MAC/BE,KAAK,eClBMC,EAAMC,GAIpB,MAAMC,EAASC,EAAO,MAChBC,EAAYD,EAAO,MAKnBE,EAAYJ,EAAMK,YAAc,GAAG,IAAML,EAAMK,eAAiBL,EAAMM,OACtEC,EAA+B,UAAlBP,EAAMQ,SAAuBR,EAAMS,SAChDC,IAAetC,EAAc4B,EAAMtB,MAKlCiC,EAAOC,GAAeC,EAAS,CACpCC,MAAOJ,EAAatC,EAAc4B,EAAMtB,KAAOsB,EAAMc,OAAS,IAC9DC,UAAWL,GAAcH,GAAcpB,IAA6BG,EACpE0B,cAAeN,GAAcV,EAAMiB,OACnCC,UAAWR,IAAc,IAMrBS,EAAYC,GAAqBR,EAAYD,QAAeA,KAAUS,KAE5E,SAASC,QD1DmBhD,EAAYyC,EC2DjCJ,ID3DqBrC,EC4DV2B,EAAMtB,ID5DgBoC,EC4DXQ,OAAOX,EAAMG,OD3D1C7C,EAAWI,GAAM,IACXJ,EAAWI,IAAO,GACjBkD,CAAC1D,OAAOS,SAASC,MAAOuC,GC0D3BK,EAAS,CAAED,WAAW,KAO1BpD,EAAuB,KAChB4C,GACHS,EAAS,CAAEL,MAAOd,EAAMc,OAAStC,EAAS2B,EAAKqB,QAASxB,EAAMtB,OAEhE,MAAM+C,GAAYd,EAAMI,oBD1CNZ,EAAMuB,GAC1B,MAAMD,EAAW,IAAI5D,OAAO0B,qBAC1B,EAAEoC,OACIA,EAAMC,gBAAkBD,EAAME,kBAAoB,KACpDJ,EAASK,UAAU3B,GACnBuB,MAGJ,CAAEK,WAAY,UAGhB,OADAN,EAASO,QAAQ7B,GACVsB,EC+BgCQ,CAAM9B,EAAKqB,QAAS,IAAML,EAAS,CAAEJ,WAAW,KAErF,GAAIR,EAAY,CACd,MAAM2B,EAAWjC,EAAOuB,QACpBU,GAAOA,EAAIC,UACbd,IAIJ,MAAO,KACDI,GACFA,EAASK,UAAU3B,EAAKqB,WAG3B,IAKH,MAAMY,GAAgBzB,EAAMK,cAAgBL,EAAMO,UAE5CmB,EAAoC,CACxCC,SAAU,WACVC,IAAK,EACLC,KAAM,EACN3D,MAAO,OACPyB,OAAQ,OACRmC,UAAWzC,EAAM0C,IACjBC,eAAgB3C,EAAMsC,UAGlBM,EAA4B,CAChCC,QAAST,EAAe,EAAI,EAC5BU,WAAYnC,EAAMK,aAAe,WAAWhB,EAAM+C,mBAAqB,UACpE/C,EAAMgD,UAELC,EAAgC,CACpCH,WAAY9C,EAAMkD,aAAevC,EAAMK,aAAe,WAAWhB,EAAM+C,wBAAqBI,EAC5FC,gBAAiBpD,EAAMkD,YAAc,IAAM,GAAGlD,EAAM+C,oBAEhDM,EAAuC,CAC3CR,QAASlC,EAAMO,UAAY,EAAI,KAC3BP,EAAMK,cAAgBiC,KACvBjD,EAAMgD,YACNhD,EAAMsD,kBAMX,OACEC,uBAAKC,MAAO,CAAElB,SAAU,WAAYmB,SAAU,UAAYC,UAAW1D,EAAM0D,WACzEH,uBACEC,MAAO,CAAE3E,MAAO,OAAQ8E,cAAevD,KAAcJ,EAAM4D,YAC3DC,IAAK1D,EACLuD,UAAW1D,EAAM8D,aAGlB9D,EAAM+D,SACLR,uBACEG,UAAW1D,EAAMgE,iBACjBR,MAAO,CACLS,gBAAiBjE,EAAM+D,WACpB1B,KACAgB,MAKPrD,EAAM+D,SAAW/D,EAAMkE,aACvBX,uBACE7E,IAAKsB,EAAMkE,YACXC,IAAKnE,EAAMmE,IACXT,UAAW1D,EAAMgE,iBACjBR,MAAO,IACFnB,KACAgB,KAKR1C,EAAMI,WACLwC,+BACGvD,EAAMoE,YACLb,0BACEc,KAAK,aACLC,OAAQ9E,EAAgBQ,EAAMoE,YAC9BtD,MAAOH,EAAMG,MAAQ,GAAGH,EAAMG,eAAYqC,IAG7CnD,EAAMsE,QACLf,0BACEe,OAAQ9E,EAAgBQ,EAAMsE,QAC9BxD,MAAOH,EAAMG,MAAQ,GAAGH,EAAMG,eAAYqC,IAI9CI,uBACEM,IAAK5D,EACLvB,IAAKsB,EAAMtB,IACXgF,UAAW1D,EAAMuE,SACjBJ,IAAKnE,EAAMmE,IACXrD,MAAO,GAAGH,EAAMG,UAGhBN,QAASD,EAAa,QAAUP,EAAMQ,QACtCgE,OAAQnD,EACRmC,MAAO,IACFnB,KACAO,OASjB7C,EAAM0E,aAAe,CACnBjE,QAAS,OACTS,QAAQ,EACRyB,IAAK,QACLJ,SAAU,SACVhC,OAAQ,OACRyC,eAAgB,IAChBoB,IAAK"}